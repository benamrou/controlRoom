<ROOT>
    <BANNER>
        SELECT DECODE(casvrec, 0, ''WARNING'', ''NORMAL'')  as CRITICALITY,
                DECODE(casvrec, 0, ''Sales load FAILED - Open a Helpdesk ticket, they will generate the report once fixed'', ''Sales loaded successfully '')  as MESSAGE
        FROM (SELECT casvrec FROM calsite@Heinens_Custom_Prod
              WHERE TRUNC(casdate)=TRUNC(SYSDATE-1)
              AND 50 > cassite
	      AND casopen=1
	      order by casvrec asc)
        WHERE rownum=1
    </BANNER>
    <QUERY> 

/* Loss and prevention - Stock movement information for a period */
WITH strucode AS (SELECT DISTINCT objcint cinrStr, pkstrucobj.get_cext@heinens_custom_prod(1,objpere) cextStr  FROM strucrel@heinens_custom_prod, STRUCTURE@heinens_custom_prod, strucobj@heinens_custom_prod
               WHERE TRUNC(CURRENT_DATE) BETWEEN  strddeb AND strdfin
               AND TRUNC(CURRENT_DATE) BETWEEN objddeb and objdfin
	       AND objpere=strcint
               AND strpere=sobcint
               AND sobcext=:param2
)
SELECT /*+ leading(art) */
DISTINCT STMSITE "Site",
         ARTCEXR "Item code",
         pkstrucobj.get_desc@heinens_custom_prod(1, aruclibl, ''HN'') "Description",
         ARLCEXVL "LV",
         pkparpostes.get_postlibl@heinens_custom_prod(1, 0, 731, ARUTYPUL, ''HN'') "LU type",
         TO_CHAR(STMDMVT, ''MM/DD/RR'') "Movement date",
         TO_CHAR(STMDMVT, ''HH24:MI:SS'') "Time",
         pkparpostes.get_postlibc@heinens_custom_prod(1, 0, 1068, STMTMVT, ''HN'') "Movement type",
         pkparpostes.get_postlibc@heinens_custom_prod(1, 0, 506, STMMOTF, ''HN'') "Rsn.",
         STMSEQ "Movement no.",
         ROUND(Decode(artustk,
                      2,
                      stmrea,
                      DECODE(pkartstock.ConvertirQteUl_VL@heinens_custom_prod(1,
                                                          abs(stmrea),
                                                          stmcinl,
                                                          stmseqvl,
                                                          1),
                             -1,
                             stmrea,
                             pkartstock.ConvertirQteUl_VL@heinens_custom_prod(1,
                                                          stmrea,
                                                          stmcinl,
                                                          stmseqvl,
                                                          1))),
               10) "Replen. qty",
         Decode(artustk,
                2,
                PKSTOCK.getUniteStockReappro@heinens_custom_prod(1, 0, artustk, artufac, ''HN''),
                DECODE(pkartstock.ConvertirQteUl_VL@heinens_custom_prod(1,
                                                    abs(stmrea),
                                                    stmcinl,
                                                    stmseqvl,
                                                    1),
                       -1,
                       PKSTOCK.getUniteStockReappro@heinens_custom_prod(1,
                                                    0,
                                                    artustk,
                                                    artufac,
                                                    ''HN''),
                       pkparpostes.get_postlibl@heinens_custom_prod(1, 0, 731, 1, ''HN''))) "Unit",
         ROUND(Decode(artustk,
                      1,
                      DECODE(pkartstock.ConvertirQteUl_VL@heinens_custom_prod(1,
                                                          abs(stmval),
                                                          stmcinl,
                                                          stmseqvl,
                                                          1),
                             -1,
                             stmval,
                             pkartstock.ConvertirQteUl_VL@heinens_custom_prod(1,
                                                          stmval,
                                                          stmcinl,
                                                          stmseqvl,
                                                          1)),
                      stmval),
               10) "Valuation qty",
         Decode(artustk,
                1,
                DECODE(pkartstock.ConvertirQteUl_VL@heinens_custom_prod(1,
                                                    abs(stmval),
                                                    stmcinl,
                                                    stmseqvl,
                                                    1),
                       -1,
                       PKSTOCK.getUniteStockValo@heinens_custom_prod(1, 0, artufac, ''HN''),
                       pkparpostes.get_postlibl@heinens_custom_prod(1, 0, 731, 1, ''HN'')),
                PKSTOCK.getUniteStockValo@heinens_custom_prod(1, 0, artufac, ''HN'')) "Unit",
         ROUND(STMVPV / DECODE(STOMVT.STMVAL, 0, 1, STOMVT.STMVAL), 3) "Sales price",
         REPLACE(pkartstock.getLibUniteFacturByCinr@heinens_custom_prod(1, artcinr, 0, ''HN''),
                 ''-1'',
                 '''') "SP unit",
         STMVPV "Amount",
         decode(STMCEXMVT, NULL, NULL, STMNLIG) "Operation code",
         pkparpostes.get_postlibl@heinens_custom_prod(1,
                                  10,
                                  506,
                                  STMIMPU,
                                  ''HN'') "Charging code",
         pkparpostes.get_postlibl@heinens_custom_prod(1,
                                  10,
                                  1066,
                                  STMTPOS,
                                  ''HN'') "Position type",
         decode(STMTPOS,
                2,
                decode(pkopros.get_CEXT@heinens_custom_prod(1, STMNPOS),
                       ''-1'',
                       ''0'',
                       pkopros.get_CEXT@heinens_custom_prod(1, STMNPOS)),
                STMNPOS) "Position no.",
         STMNLIG "Operation line no.",
         STMVPA "Purchase price value",
         stmvpr "Cost price value",
         stmmcre "Incl. CP layer adjustment",
         stmcrea "Incl. PP layer adjustment",
         stmmdre "Incl. cost markdown",
         stmdrea "Incl. purchase markdown",
         STMVPR + STMMLPP "PR val. w/o disc.",
         stmmdar "Cost mark. ad. am.",
         stmdara "Purch. mark. add. amt",
         stmtva "VAT value",
         stmmdvt "Generated SP mark.",
         REPLACE(stmnmvc, -1, NULL) "Reversal mvmt no.",
         REPLACE(stmctpt, -1, NULL) "Transf. reversal site",
         REPLACE(PKSITDGENE.get_sitedescription@heinens_custom_prod(1, STMCTPT), ''-1'', '''') "Description",
         STMMLPP "Cost LPP mark.",
         STMLPPA "Purch. LPP mark.",
         ROUND(DECODE(pkartstock.ConvertirQteUl_VL@heinens_custom_prod(1,
                                                   abs(NVL(pkstock.getStockDispoEnQteuvc_VL@heinens_custom_prod(1,
                                                                                            STMSITE,
                                                                                            STMCINL,
                                                                                            STMSEQVL),
                                                           0)),
                                                   stmcinl,
                                                   stmseqvl,
                                                   1),
                      -1,
                      NVL(pkstock.getStockDispoEnQteuvc_VL@heinens_custom_prod(1,
                                                           STMSITE,
                                                           STMCINL,
                                                           STMSEQVL),
                          0),
                      pkartstock.ConvertirQteUl_VL@heinens_custom_prod(1,
                                                   NVL(pkstock.getStockDispoEnQteuvc_VL@heinens_custom_prod(1,
                                                                                        STMSITE,
                                                                                        STMCINL,
                                                                                        STMSEQVL),
                                                       0),
                                                   stmcinl,
                                                   stmseqvl,
                                                   1)),
               10) "Avail. qty",
         ROUND(DECODE(pkartstock.ConvertirQteUl_VL@heinens_custom_prod(1,
                                                   abs(NVL(pkstock.getStockEnCommandeVL@heinens_custom_prod(1,
                                                                                        STMSITE,
                                                                                        STMCINL,
                                                                                        STMSEQVL),
                                                           0)),
                                                   stmcinl,
                                                   stmseqvl,
                                                   1),
                      -1,
                      NVL(pkstock.getStockEnCommandeVL@heinens_custom_prod(1,
                                                       STMSITE,
                                                       STMCINL,
                                                       STMSEQVL),
                          0),
                      pkartstock.ConvertirQteUl_VL@heinens_custom_prod(1,
                                                   NVL(pkstock.getStockEnCommandeVL@heinens_custom_prod(1,
                                                                                    STMSITE,
                                                                                    STMCINL,
                                                                                    STMSEQVL),
                                                       0),
                                                   stmcinl,
                                                   stmseqvl,
                                                   1)),
               10) "Ordered quantity",
         ROUND(DECODE(pkartstock.ConvertirQteUl_VL@heinens_custom_prod(1,
                                                   abs(NVL(pkstock.getStockBloqueVL@heinens_custom_prod(1,
                                                                                    STMSITE,
                                                                                    STMCINL,
                                                                                    STMSEQVL),
                                                           0)),
                                                   stmcinl,
                                                   stmseqvl,
                                                   1),
                      -1,
                      NVL(pkstock.getStockBloqueVL@heinens_custom_prod(1,
                                                   STMSITE,
                                                   STMCINL,
                                                   STMSEQVL),
                          0),
                      pkartstock.ConvertirQteUl_VL@heinens_custom_prod(1,
                                                   NVL(pkstock.getStockBloqueVL@heinens_custom_prod(1,
                                                                                STMSITE,
                                                                                STMCINL,
                                                                                STMSEQVL),
                                                       0),
                                                   stmcinl,
                                                   stmseqvl,
                                                   1)),
               10) "Blocked qty",
         ROUND(NVL(pkstock.getStockDispoEnValeurVL@heinens_custom_prod(1,
                                                   STMSITE,
                                                   STMCINL,
                                                   STMSEQVL),
                   0),
               3) "Stock in value",
         ROUND((STMVPA / decode(Decode(artustk,
                                       1,
                                       DECODE(pkartstock.ConvertirQteUl_VL@heinens_custom_prod(1,
                                                                           abs(stmval),
                                                                           stmcinl,
                                                                           stmseqvl,
                                                                           1),
                                              -1,
                                              stmval,
                                              pkartstock.ConvertirQteUl_VL@heinens_custom_prod(1,
                                                                           stmval,
                                                                           stmcinl,
                                                                           stmseqvl,
                                                                           1)),
                                       stmval),
                                0,
                                1,
                                Decode(artustk,
                                       1,
                                       DECODE(pkartstock.ConvertirQteUl_VL@heinens_custom_prod(1,
                                                                           abs(stmval),
                                                                           stmcinl,
                                                                           stmseqvl,
                                                                           1),
                                              -1,
                                              stmval,
                                              pkartstock.ConvertirQteUl_VL@heinens_custom_prod(1,
                                                                           stmval,
                                                                           stmcinl,
                                                                           stmseqvl,
                                                                           1)),
                                       stmval))),
               5) "Unit purchase price",
         ROUND(nvl(STMUPR, 0),5) "Unit cost",
         STMSTOC "Managed in stock",
         cextStr "Merchandise hierarchy"
  FROM ARTRAC@heinens_custom_prod,
       ARTUL@heinens_custom_prod,
       STOMVT@heinens_custom_prod,
       ARTVL@heinens_custom_prod,
       strucode str
 WHERE ARUCINR = ARTCINR
   AND stmcinl = arucinl
   AND arucinr = cinrStr
   /* AND artcexr=''585906'' */
   AND STMDMVT >= TO_DATE(:param3, ''MM/DD/RR'')
   AND TO_DATE(:param4, ''MM/DD/RR'') + 1 > STMDMVT
   AND EXISTS
 (SELECT 1
          FROM GRDETSITE@heinens_custom_prod
         WHERE GSDNGR = 100
           AND TRUNC(CURRENT_DATE) BETWEEN gsdddeb AND gsddfin
           AND STMSITE = gsdsite)
   AND STMSEQVL = arlseqvl
AND NOT EXISTS (SELECT 1 FROM calsite@Heinens_Custom_Prod
                    WHERE TRUNC(casdate) BETWEEN TRUNC(SYSDATE-5) AND TRUNC(SYSDATE-1)
                    AND 50 > cassite
                    AND casopen=1
                    AND casvrec =0)

</QUERY>
 
  <HEADERIFEMPTY>No loss and prevention data</HEADERIFEMPTY>
  <HEADER>Loss and prevention movement data</HEADER>
  
</ROOT>

